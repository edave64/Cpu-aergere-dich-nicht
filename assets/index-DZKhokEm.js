(function(){let e=document.createElement(`link`).relList;if(e&&e.supports&&e.supports(`modulepreload`))return;for(let e of document.querySelectorAll(`link[rel="modulepreload"]`))n(e);new MutationObserver(e=>{for(let t of e)if(t.type===`childList`)for(let e of t.addedNodes)e.tagName===`LINK`&&e.rel===`modulepreload`&&n(e)}).observe(document,{childList:!0,subtree:!0});function t(e){let t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin===`use-credentials`?t.credentials=`include`:e.crossOrigin===`anonymous`?t.credentials=`omit`:t.credentials=`same-origin`,t}function n(e){if(e.ep)return;e.ep=!0;let n=t(e);fetch(e.href,n)}})();var e={First:0,Reroll:1,ReserveEscape:2},t=class{players;intelligences;paths=new Map;pieces=new Map;turnState=e.First;rollCallbacks=[];i=0;constructor(e,t,n){this.players=e,this.intelligences=t,this.paths=n,this.pieces=new Map(e.map(e=>[e,[new r(0,`reserve`),new r(1,`reserve`),new r(2,`reserve`),new r(3,`reserve`)]]))}getWinner(){for(let e of this.players)if(this.pieces.get(e)?.every(e=>e.section===`home`))return e}async nextMove(){let t=this.i,i=this.players[t],a=this.intelligences.get(i),o=this.paths.get(i),s=this.pieces.get(i),c=s.filter(e=>e.section===`field`),l=o.length,u=n();u===6?this.turnState=e.Reroll:this.turnState===e.Reroll?this.turnState=e.First:this.turnState===e.ReserveEscape?this.turnState=e.Reroll:c.length===0&&(this.turnState=e.ReserveEscape),this.turnState===e.First&&(this.i=(t+1)%this.players.length),console.log(`player ${i} rolled ${u}`);let d=[];this.rollCallbacks.forEach(e=>e(u,i));let f=s.filter(e=>e.section===`reserve`);if(u===6&&f.length>0){let e=o[0];c.find(t=>t.index===e)||d.push([f[0],new r(e,`field`)])}let p=s.filter(e=>e.section===`home`),m=[0,1,2,3].map(e=>!p.find(t=>t.index===e));for(let e of c){let t=o.findIndex(t=>t===e.index)+u;if(t<l){let n=o[t];c.find(e=>e.index===n)||d.push([e,new r(o[t],`field`)])}else{let n=t-l;m[n]&&d.push([e,new r(n,`home`)])}}for(let e of p)m[e.index+u]&&d.push([e,new r(e.index+u,`home`)]);if(d.length===0)return null;let h=await a.getNextMove(this,u,d),g=s.findIndex(e=>e===h[0]);s[g]=h[1];for(let e of this.players){if(e===i)continue;let t=this.pieces.get(e),n=t.findIndex(e=>e.section===`field`&&e.index===h[1].index);if(n!==-1){t[n]=new r([0,1,2,3].find(e=>!t.find(t=>t.section===`reserve`&&t.index===e)),`reserve`);break}}return h}onRoll(e){this.rollCallbacks.push(e)}};function n(){let e=Math.floor(Math.random()*6);return e===6?6:e+1}var r=class{section;index;constructor(e,t=`reserve`){this.index=e,this.section=t}},i=class{getNextMove(e,t,n){return n[Math.floor(Math.random()*n.length)]}},a=class{player;constructor(e){this.player=e}getNextMove(e,t,n){return n.sort((t,n)=>e.paths.get(this.player).indexOf(t[0].index)-e.paths.get(this.player).indexOf(n[0].index))[0]}},o=class{player;constructor(e){this.player=e}getNextMove(e,t,n){return n.sort((t,n)=>e.paths.get(this.player).indexOf(n[0].index)-e.paths.get(this.player).indexOf(t[0].index))[0]}},s=Array.from(document.querySelectorAll(`svg > circle`)),c=new Map,l=new Map,u=new Map,d=new Map,f=new Set,p=0;do{let e,t=p,n=s[t];if(p=(p+1)%s.length,n.classList.length>0){let t=n.classList[0];t.endsWith(`_goal`)?e=t.slice(0,-5):c.has(t)||(f.add(t),c.set(t,[]),l.set(t,Array.from(document.querySelectorAll(`svg > .${t}_reserve > circle`))),u.set(t,Array.from(document.querySelectorAll(`svg > .${t}_home > circle`))))}for(let e of f)c.get(e).push(t);e&&f.delete(e)}while(f.size>0);function m(e){for(let t of e.players){let n=d.get(t);n===void 0&&(n=[0,0,0,0].map(e=>{let n=document.createElementNS(`http://www.w3.org/2000/svg`,`circle`);return n.setAttribute(`cx`,`0`),n.setAttribute(`cy`,`0`),n.setAttribute(`r`,`24`),n.style.stroke=`#fff`,n.style.pointerEvents=`none`,n.classList.add(t),document.querySelector(`svg`).appendChild(n),n}),d.set(t,n));for(let r=0;r<4;r++){let i=n[r],a=e.pieces.get(t)[r],o;if(a.section===`field`)o=s[a.index];else if(a.section===`home`)o=u.get(t)[a.index];else if(a.section===`reserve`)o=l.get(t)[a.index];else throw Error(`Unknown piece position`);i.style.transform=`translate(${o.getAttribute(`cx`)}px, ${o.getAttribute(`cy`)}px)`}}}var h=null,g=document.getElementById(`winBanner`),_=document.getElementById(`play`),v=document.getElementById(`speed`);_.addEventListener(`click`,()=>{(!h||h.winner!==void 0)&&(h=new y),h.start()});var y=class{state;nextMoveTimeout=null;abortController=new AbortController;_winner=void 0;_running=!1;constructor(){g.textContent=``,this.state=new t([...u.keys()],new Map([...u.keys()].map(([e,t])=>{let n=document.getElementById(`${e}-intelligence`).value,r;switch(n){case`manual`:r=new C(e);break;case`eager`:r=new o(e);break;case`cluster`:r=new a(e);break;default:r=new i}return[e,r]})),c),this.state.onRoll((e,t)=>{let n=document.querySelector(`rect`);n.style.display=`block`,n.setAttribute(`class`,t),document.getElementById(`dice`).setAttribute(`aria-valuenow`,e.toString())})}get winner(){return this._winner}async start(){if(this._running)return;this._running=!0;let e=this;await t();async function t(){e._running&&(await e.step(),e._winner===void 0?v.valueAsNumber<=0?t():e.nextMoveTimeout=setTimeout(t,v.valueAsNumber):(e.abortController.abort(),g.textContent=b.get(e._winner)))}}stop(){this._running=!1,this.nextMoveTimeout!==null&&(clearTimeout(this.nextMoveTimeout),this.nextMoveTimeout=null)}async step(){this._winner===void 0&&(await this.state.nextMove(),this._winner=this.state.getWinner(),m(this.state))}},b=new Map([[`y`,`Yellow`],[`g`,`Green`],[`r`,`Red`],[`b`,`Black`]]),x=document.getElementById(`sidebar`);for(let e of u.keys()){let t=document.getElementById(`intelligence-template`).content.cloneNode(!0),n=t.querySelector(`label`);n.setAttribute(`for`,e+`-intelligence`),n.querySelector(`span`).textContent=b.get(e);let r=t.querySelector(`select`);r.value=`random`,r.id=e+`-intelligence`,x.appendChild(t)}var S=new Map,C=class{player;constructor(e){this.player=e}getNextMove(e,t,n){let r=[];for(let e of n){let t=e[0],n=e[1],i;if(t.section===`field`?i=s[t.index]:t.section===`home`?i=u.get(this.player)[t.index]:t.section===`reserve`&&(i=l.get(this.player)[t.index]),!i)throw Error(`Unknown piece position`);let a=new Promise(e=>{S.set(i,()=>{e([t,n])})});r.push(a)}return Promise.race(r)}};document.body.addEventListener(`pointerdown`,e=>{let t=S.get(e.target);t&&(S.clear(),t())}),console.log(c),console.log(l),console.log(u);